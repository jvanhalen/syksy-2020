<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>
    
    SQLite Pythonissa - Tietokantojen perusteet syksy 2020
    
  </title>
  <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        CommonHTML: {
          scale: 87
        }
      });
      </script>
  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <link rel='stylesheet' type='text/css' media='screen' href=/syksy-2020/assets/css/main.css>
  <link rel='stylesheet' type='text/css' media='screen' href=/syksy-2020/assets/css/syntax.css>

  <script src=/syksy-2020/assets/js/main.js></script>

</head>


<body id="chapter">
    
<nav class="no-nav" id="side-nav" >
    <button id="hide" onclick="hideSideNav()"> &#x2715;</button>
    <button id="show" onclick="showSideNav()"> </button>
    <h2>Tietokantojen perusteet syksy 2020</h2>
    
    <ol>

        <li class="side-nav-obj" id="indexnav"><a href=/syksy-2020/index>Etusivu </a></li>
        
        
        
        <li class="side-nav-obj" id="Materiaalinav"><a href="/syksy-2020/pages/materiaali.html">Materiaali</a></li>
        
        
        
        
        
        
        
        
        
        <li class="side-nav-obj" id="Tehtävät ja harjoitustyönav"><a href="/syksy-2020/pages/tehtavat.html">Tehtävät ja harjoitustyö</a></li>
        
        
        <br>
        
        
        <li class="side-nav-obj" id="1. Johdantonav"><a href="/syksy-2020/content/osa-1/index.html">1. Johdanto</a></li>
        
        
            
            <li class="side-nav-sub-obj" id="Mikä on tietokanta?nav"><a href="/syksy-2020/content/osa-1/index.html#mikä-on-tietokanta?">Mikä on tietokanta?</a></li>
        
            
            <li class="side-nav-sub-obj" id="Tee-se-itse-tietokantanav"><a href="/syksy-2020/content/osa-1/index.html#tee-se-itse-tietokanta">Tee-se-itse-tietokanta</a></li>
        
            
            <li class="side-nav-sub-obj" id="Relaatiomalli ja SQL-kielinav"><a href="/syksy-2020/content/osa-1/index.html#relaatiomalli-ja-sql-kieli">Relaatiomalli ja SQL-kieli</a></li>
        
            
        
        
        
        
        <li class="side-nav-obj" id="2. SQL-kielen perusteetnav"><a href="/syksy-2020/content/osa-2/index.html">2. SQL-kielen perusteet</a></li>
        
        
            
            <li class="side-nav-sub-obj" id="Peruskomennotnav"><a href="/syksy-2020/content/osa-2/index.html#peruskomennot">Peruskomennot</a></li>
        
            
            <li class="side-nav-sub-obj" id="Yhteenveto ja ryhmittelynav"><a href="/syksy-2020/content/osa-2/index.html#yhteenveto-ja-ryhmittely">Yhteenveto ja ryhmittely</a></li>
        
            
            <li class="side-nav-sub-obj" id="SQLite-tietokantanav"><a href="/syksy-2020/content/osa-2/index.html#sqlite-tietokanta">SQLite-tietokanta</a></li>
        
            
        
        
        
        
        <li class="side-nav-obj" id="3. Monen taulun kyselytnav"><a href="/syksy-2020/content/osa-3/index.html">3. Monen taulun kyselyt</a></li>
        
        
            
            <li class="side-nav-sub-obj" id="Taulujen viittauksetnav"><a href="/syksy-2020/content/osa-3/index.html#taulujen-viittaukset">Taulujen viittaukset</a></li>
        
            
            <li class="side-nav-sub-obj" id="Liitostaulutnav"><a href="/syksy-2020/content/osa-3/index.html#liitostaulut">Liitostaulut</a></li>
        
            
            <li class="side-nav-sub-obj" id="JOIN-syntaksinav"><a href="/syksy-2020/content/osa-3/index.html#join-syntaksi">JOIN-syntaksi</a></li>
        
            
        
        
        
        
        <li class="side-nav-obj" id="4. Lisää SQL-kielestänav"><a href="/syksy-2020/content/osa-4/index.html">4. Lisää SQL-kielestä</a></li>
        
        
            
            <li class="side-nav-sub-obj" id="Tyypit ja lausekkeetnav"><a href="/syksy-2020/content/osa-4/index.html#tyypit-ja-lausekkeet">Tyypit ja lausekkeet</a></li>
        
            
            <li class="side-nav-sub-obj" id="NULL-arvotnav"><a href="/syksy-2020/content/osa-4/index.html#null-arvot">NULL-arvot</a></li>
        
            
            <li class="side-nav-sub-obj" id="Alikyselytnav"><a href="/syksy-2020/content/osa-4/index.html#alikyselyt">Alikyselyt</a></li>
        
            
            <li class="side-nav-sub-obj" id="Lisää tekniikoitanav"><a href="/syksy-2020/content/osa-4/index.html#lisää-tekniikoita">Lisää tekniikoita</a></li>
        
            
        
        
        
        
        <li class="side-nav-obj" id="5. Tietokannan suunnittelunav"><a href="/syksy-2020/content/osa-5/index.html">5. Tietokannan suunnittelu</a></li>
        
        
            
            <li class="side-nav-sub-obj" id="Taulut ja sarakkeetnav"><a href="/syksy-2020/content/osa-5/index.html#taulut-ja-sarakkeet">Taulut ja sarakkeet</a></li>
        
            
            <li class="side-nav-sub-obj" id="Tiedon atomisuusnav"><a href="/syksy-2020/content/osa-5/index.html#tiedon-atomisuus">Tiedon atomisuus</a></li>
        
            
            <li class="side-nav-sub-obj" id="Toisteinen tietonav"><a href="/syksy-2020/content/osa-5/index.html#toisteinen-tieto">Toisteinen tieto</a></li>
        
            
            <li class="side-nav-sub-obj" id="Suunnitteluesimerkkinav"><a href="/syksy-2020/content/osa-5/index.html#suunnitteluesimerkki">Suunnitteluesimerkki</a></li>
        
            
        
        
        
        
        <li class="side-nav-obj" id="6. Tietokannan ominaisuudetnav"><a href="/syksy-2020/content/osa-6/index.html">6. Tietokannan ominaisuudet</a></li>
        
        
            
            <li class="side-nav-sub-obj" id="Tiedon eheysnav"><a href="/syksy-2020/content/osa-6/index.html#tiedon-eheys">Tiedon eheys</a></li>
        
            
            <li class="side-nav-sub-obj" id="Transaktiotnav"><a href="/syksy-2020/content/osa-6/index.html#transaktiot">Transaktiot</a></li>
        
            
            <li class="side-nav-sub-obj" id="Kyselyjen suoritusnav"><a href="/syksy-2020/content/osa-6/index.html#kyselyjen-suoritus">Kyselyjen suoritus</a></li>
        
            
            <li class="side-nav-sub-obj" id="Indeksitnav"><a href="/syksy-2020/content/osa-6/index.html#indeksit">Indeksit</a></li>
        
            
        
        
        
    </ol>
</nav>

    <div class="page-content">
        <div class="content">
    <div class="table-of-content" id="tof" style="display: none;">
    <ul>
        
    </ul>
</div>

    <h1 id="sqlite-pythonissa">SQLite Pythonissa</h1>

<p>Pythonin standardikirjaston osana on moduuli <code class="language-html highlighter-rouge">sqlite3</code>,
jonka kautta pystyy käsittelemään SQLite-tietokantaa.
Tämä sivu kertoo perusasiat moduulin käyttämisestä,
ja voit halutessasi etsiä lisätietoa Pythonin dokumentaatiosta.</p>

<h2 id="esimerkki">Esimerkki</h2>

<p>Seuraava koodi käyttää tietokantaa, joka on tiedostossa <code class="language-html highlighter-rouge">testi.db</code>.
Koodi luo taulun <code class="language-html highlighter-rouge">Tuotteet</code> ja lisää sinne viisi riviä.
Tämän jälkeen koodi hakee ja näyttää taulun rivit.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"testi.db"</span><span class="p">)</span>
<span class="n">db</span><span class="p">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"CREATE TABLE Tuotteet (id INTEGER PRIMARY KEY, nimi TEXT, hinta INTEGER)"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO Tuotteet (nimi,hinta) VALUES ('retiisi',7)"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO Tuotteet (nimi,hinta) VALUES ('porkkana',5)"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO Tuotteet (nimi,hinta) VALUES ('nauris',4)"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO Tuotteet (nimi,hinta) VALUES ('lanttu',8)"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO Tuotteet (nimi,hinta) VALUES ('selleri',4)"</span><span class="p">)</span>

<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * FROM Tuotteet"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div></div>

<p>Koodin tulostus on seuraava:</p>

<div class="language-prompt highlighter-rouge"><div class="highlight"><pre class="syntax"><code>[(1, 'retiisi', 7), (2, 'porkkana', 5), (3, 'nauris', 4), (4, 'lanttu', 8), (5, 'selleri', 4)]
</code></pre></div></div>

<p>Tietokantaa käytetään <em>kursorin</em> kautta,
jonka metodi <code class="language-html highlighter-rouge">execute</code> suorittaa halutun komennon.
Komennon <code class="language-html highlighter-rouge">SELECT</code> suorituksen jälkeen metodi <code class="language-html highlighter-rouge">fetchall</code>
hakee tulosrivit.</p>

<p>Asetus <code class="language-html highlighter-rouge">isolation_level = None</code> tarkoittaa, että oletuksena jokainen
komento on oma transaktionsa (kuten SQLite-tulkissa).</p>

<p>Huomaa, että jos suoritat koodin uudestaan,
tapahtuu virhe, koska taulu <code class="language-html highlighter-rouge">Tuotteet</code> on jo tietokannassa mutta
ohjelma yrittää luoda sen uudestaan.
Voit aina halutessasi nollata tietokannan sisällön
poistamalla tiedoston <code class="language-html highlighter-rouge">testi.db</code>.</p>

<h2 id="tiedon-hakeminen-käyttäjänä">Tiedon hakeminen käyttäjänä</h2>

<p>Seuraava koodi näyttää esimerkin, jossa käyttäjä pystyy
hakemaan tietoa tietokannasta, jossa on valmiina taulu <code class="language-html highlighter-rouge">Tuotteet</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"testi.db"</span><span class="p">)</span>
<span class="n">db</span><span class="p">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Anna tuotteen nimi:"</span><span class="p">)</span>
<span class="n">nimi</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>

<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT hinta FROM Tuotteet WHERE nimi=?"</span><span class="p">,[</span><span class="n">nimi</span><span class="p">])</span>
<span class="n">tiedot</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="k">if</span> <span class="n">tiedot</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Hinta:"</span><span class="p">,</span><span class="n">tiedot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Tuotetta ei löytynyt"</span><span class="p">)</span>    
</code></pre></div></div>

<p>Tässä on käytössä <em>parametrisoitu</em> kysely,
jossa on käyttäjän antaman tiedon kohdalla <code class="language-html highlighter-rouge">?</code> ja
tieto annetaan erikseen listassa kyselyn jälkeen.
Metodi <code class="language-html highlighter-rouge">fetchone</code> antaa yhden tulosrivin tai <code class="language-html highlighter-rouge">None</code>,
jos kysely ei palauttanut mitään riviä.</p>

<p>Tässä on esimerkkejä koodin toiminnasta:</p>

<div class="language-prompt highlighter-rouge"><div class="highlight"><pre class="syntax"><code>Anna tuotteen nimi:
selleri
Hinta: 4
</code></pre></div></div>

<div class="language-prompt highlighter-rouge"><div class="highlight"><pre class="syntax"><code>Anna tuotteen nimi:
banaani
Tuotetta ei löytynyt
</code></pre></div></div>

<p>Parametrisoitu kysely on turvallinen tapa yhdistää käyttäjän
antamaa tietoa kyselyyn,
koska tällöin käyttäjän antama tieto ei sekoitu SQL-komentoihin.
Sen sijaan vaarallinen tapa olisi yhdistää käyttäjän antama
tieto suoraan kyselyyn:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT hinta FROM Tuotteet WHERE nimi='"</span><span class="o">+</span><span class="n">nimi</span><span class="o">+</span><span class="s">"'"</span><span class="p">)</span>
</code></pre></div></div>

<p>Nyt käyttäjä voisi antaa vaikka seuraavan tuotteen “nimen”:</p>

<div class="language-prompt highlighter-rouge"><div class="highlight"><pre class="syntax"><code>Anna tuotteen nimi:
' OR id=1 OR nimi='
Hinta: 7
</code></pre></div></div>

<p>Tämä tuottaa kyselyn <code class="language-html highlighter-rouge">SELECT hinta FROM Tuotteet WHERE nimi='' OR id=1 OR nimi=''</code>,
joka hakeekin tietokannasta tuotteen, jonka id on 1.
Käyttäjä voisi siis koettaa hakea tietoa, johon hänellä ei kuuluisi olla pääsyä.</p>

<p>Tällaisesta kyselyn rakennetta muuttavasta käyttäjän antamasta
tiedosta käytetään nimeä <em>SQL-injektio</em>.
Tämä oli etenkin takavuosina tavallinen tapa murtautua
huonosti toteutettuihin nettisivustoihin.</p>

<h2 id="tiedon-muuttaminen-käyttäjänä">Tiedon muuttaminen käyttäjänä</h2>

<p>Tässä on vielä esimerkki, jossa käyttäjä pystyy lisäämään tuotteen:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"testi.db"</span><span class="p">)</span>
<span class="n">db</span><span class="p">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Anna tuotteen nimi:"</span><span class="p">)</span>
<span class="n">nimi</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Anna tuotteen hinta:"</span><span class="p">)</span>
<span class="n">hinta</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>

<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO Tuotteet(nimi,hinta) VALUES (?,?)"</span><span class="p">,[</span><span class="n">nimi</span><span class="p">,</span><span class="n">hinta</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Tuote lisätty id:llä"</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">lastrowid</span><span class="p">)</span>
</code></pre></div></div>

<p>Kuten tiedon hakemisessa, turvallinen tapa toteuttaa kysely on
käyttää parametrisoitua kyselyä.
Rivin lisäämisen jälkeen kentässä <code class="language-html highlighter-rouge">lastrowid</code> on 
lisätyn rivin id-numero, josta olisi hyötyä,
jos esimerkiksi lisäisimme vielä toisen rivin,
joka viittaa siihen.</p>

<p>Koodin suoritus voi näyttää seuraavalta:</p>

<div class="language-prompt highlighter-rouge"><div class="highlight"><pre class="syntax"><code>Anna tuotteen nimi:
banaani
Anna tuotteen hinta:
3
Tuote lisätty id:llä 6
</code></pre></div></div>

<h2 id="virheenkäsittely">Virheenkäsittely</h2>

<p>Jos kyselyssä tapahtuu virhe, niin tämä keskeyttää ohjelman suorituksen.
Näin käy vaikkapa seuraavassa kyselyssä, jos taulua <code class="language-html highlighter-rouge">Kurssit</code> ei ole olemassa:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * FROM Kurssit"</span><span class="p">)</span>
</code></pre></div></div>

<p>Tässä tapauksessa ohjelma päättyy seuraavaan virheeseen:</p>

<div class="language-prompt highlighter-rouge"><div class="highlight"><pre class="syntax"><code>Traceback (most recent call last):
  File "testi4.py", line 7, in &lt;module&gt;
      c.execute("SELECT * FROM Kurssit")
sqlite3.OperationalError: no such table: Kurssit
</code></pre></div></div>

<p>Voimme kuitenkin halutessamme varautua virheeseen <code class="language-html highlighter-rouge">try</code>-rakenteen
avulla vaikkapa näin:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * FROM Kurssit"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Kysely ei onnistunut"</span><span class="p">)</span>    
</code></pre></div></div>

<p>Nyt virhetilanteessa ohjelma tulostaa viestin ja jatkaa toimintaansa.</p>

</div>
        <div class="footer">
    <img src=/syksy-2020/assets/img/HY_logo.png>
    </div>
    </div>
</body>

</html>